import discord
from discord.ext import commands
from discord.ui import Button, View
import config

class MusicView(View):
    def __init__(self, ctx, msg, playlist):
        super().__init__(timeout=None)
        self.__ctx = ctx
        self.__msg = msg
        self.__isPaused = False
        self.__playlist = playlist
        self.__loopstatus = ""

        self.__plpa_button = Button(style=discord.ButtonStyle.secondary, label="‚èØÔ∏è")
        self.__plpa_button.callback = self.__plpa
        self.__shuff_button = Button(style=discord.ButtonStyle.secondary, label="üîÄ")
        self.__shuff_button.callback = self.__shuffle
        self.__skip_button = Button(style=discord.ButtonStyle.secondary, label="‚è©")
        self.__skip_button.callback = self.__skip
        self.__loop_button = Button(style=discord.ButtonStyle.secondary, label="üîÅ")
        self.__loop_button.callback = self.__loop

        self.__add_buttons()

    async def __plpa(self, interaction):
        await interaction.response.defer()
        if self.__ctx.voice_client.is_playing():
            self.__ctx.voice_client.pause()
        else:
            self.__ctx.voice_client.resume()
        self.__isPaused = not self.__isPaused

    async def __skip(self, interaction):
        await interaction.response.defer()
        if self.__ctx and self.__ctx.voice_client.is_playing():
            self.__ctx.voice_client.stop()

    async def __shuffle(self, interaction):
        await interaction.response.defer()
        self.__playlist.shuffle()

    async def __loop(self, interaction):
        await interaction.response.defer()
        self.__loopstatus = self.__playlist.loop()

    def __add_buttons(self):
        self.clear_items()
        self.add_item(self.__plpa_button)
        if not self.__playlist.isEmpty():
            self.add_item(self.__shuff_button)
            self.add_item(self.__skip_button)
        self.add_item(self.__loop_button)

    async def edit_message(self):
        embed = discord.Embed(title="Zenelej√°tsz√≥", color=0xFF0000)

        if self.__playlist.isEmpty() and not self.__ctx.voice_client.is_playing() and not self.__isPaused:
           embed.add_field(name="St√°tusz", value="Jelenleg nem megy zene.", inline=False)
        else:
            if self.__isPaused:
                embed.add_field(name="St√°tusz", value=f"‚è∏Ô∏è{self.__loopstatus}", inline=False)
            else:
                embed.add_field(name="St√°tusz", value=f"‚ñ∂Ô∏è{self.__loopstatus}", inline=False)

            if self.__playlist.current:
                embed.add_field(name="Jelenlegi zene", value=f"{self.__playlist.current['title']}", inline=False)
            else:
                embed.add_field(name="Jelenlegi zene", value="N/A", inline=False)

            embed.add_field(name="Lej√°szt√°si lista", value=f"{self.__playlist.tostring()}", inline=False)

        self.__add_buttons()
        await self.__msg.edit(content=None, embed=embed, view=self)


class ChoosingView(View):
    def __init__(self, msg, response, search_results):
        super().__init__(timeout=None)
        self.__msg = msg
        self.__resp = response
        self.__search_results = search_results
        self.__emojis = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£"]

        for i in range(5):
            button = Button(style=discord.ButtonStyle.secondary, label=f"{self.__emojis[i]}")
            button.callback = self.__create_callback(i)
            self.add_item(button)

    def __create_callback(self, i):
        async def callback(interaction: discord.Interaction):
            self.__resp.answer = i
            await interaction.response.defer()
            await self.__msg.delete()
        return callback

    async def edit_message(self):
        embed = discord.Embed(title="Tal√°latok", color=0xFF0000)

        results = ""
        for i, item in enumerate(self.__search_results['entries']):
            results += f"{i+1}. {item['title']}\n"

        embed.add_field(name="V√°lassz egy zen√©t a list√°b√≥l:", value=results, inline=False)

        await self.__msg.edit(content=None, embed=embed, view=self)

class RivalsPlayerView(View):
    def __init__(self, msg, data, name, season):
        super().__init__(timeout=None)
        self.__msg = msg
        self.__data = data
        self.__name = name
        self.__season = season

    async def edit_message(self):
        string = f"{self.__name} rangsorolt statisztik√°i S{self.__season}"
        title = f"{string}{self.__calculate_spaces(string)}"
        embed = discord.Embed(title=title, color=0x800080)

        embed.set_thumbnail(url=self.__data['heroes'][0]['img_url'])

        embed.add_field(name="Rank", value=self.__data['rank'], inline=False)

        embed.add_field(name="Gy≈ëzelmi ar√°ny", value=f"{self.__data['winrate']}%", inline=False)

        heroes_data = ""
        for hero in self.__data['heroes']:
            heroes_data += f"\n**{hero['name'].title()}**\nMeccsek: {hero['matches']}\nGy≈ëzelmi ar√°ny: {hero['winrate']}%\nMVP/SVP: {hero['mvpsvp']}\nJ√°tszott id≈ë: {hero['playtime']} √≥ra\n"
        embed.add_field(name=f"Top {len(self.__data['heroes'])} h≈ës", value=heroes_data, inline=False)

        embed.add_field(name="Utolj√°ra friss√≠tve", value=self.__data['update'], inline=False)

        await self.__msg.edit(content=None, embed=embed, view=self)

    def __calculate_spaces(self, title):
        if (70-len(title)>0):
            return (70-len(title))*" \u200b"
        return ""

class RivalsMapView(View):
    def __init__(self, msg, data, name, season):
        super().__init__(timeout=None)
        self.__msg = msg
        self.__data = data
        self.__name = name
        self.__season = season

    async def edit_message(self):
        string = f"{self.__name} p√°lya statisztik√°i S{self.__season}"
        title = f"{string}{self.__calculate_spaces(string)}"
        embed = discord.Embed(title=title, color=0x800080)

        for m in self.__data['maps']:
            map_data = f"Meccsek: {m['matches']}\nGy≈ëzelmi ar√°ny: {m['winrate']}"
            embed.add_field(name=m['name'], value=map_data, inline=False)

        embed.add_field(name="Utolj√°ra friss√≠tve", value=self.__data['update'], inline=False)

        await self.__msg.edit(content=None, embed=embed, view=self)

    def __calculate_spaces(self, title):
        if (50-len(title)>0):
            return (50-len(title))*" \u200b"
        return ""

class RivalsMatchupView(View):
    def __init__(self, msg, data, name, season, half):
        super().__init__(timeout=None)
        self.__msg = msg
        self.__data = data
        self.__name = name
        self.__season = season
        self.__half = half

    async def edit_message(self):
        embed = None
        if self.__half == 1:
            string = f"{self.__name} matchup statisztik√°i S{self.__season}"
            title = f"{string}{self.__calculate_spaces(string)}"
            embed = discord.Embed(title=title, color=0x800080)

            for h in self.__data['heroes'][:24]:
                map_data = f"Meccsek: {h['matches']}\nGy≈ëzelmi ar√°ny: {h['winrate']}"
                embed.add_field(name=h['name'].title(), value=map_data, inline=False)


        elif self.__half == 2:
            string = f"{self.__name} matchup statisztik√°i S{self.__season}"
            title = f"{string}{self.__calculate_spaces(string)}"
            embed = discord.Embed(title=title, color=0x800080)
            for h in self.__data['heroes'][24:]:
                map_data = f"Meccsek: {h['matches']}\nGy≈ëzelmi ar√°ny: {h['winrate']}"
                embed.add_field(name=h['name'].title(), value=map_data, inline=False)

        if len(self.__data['heroes']) < 25 and self.__half == 1:
            embed.add_field(name="Utolj√°ra friss√≠tve", value=self.__data['update'], inline=False)
        elif self.__half == 2:
            embed.add_field(name="Utolj√°ra friss√≠tve", value=self.__data['update'], inline=False)

        await self.__msg.edit(content=None, embed=embed, view=self)

    def __calculate_spaces(self, title):
        if (50-len(title)>0):
            return (50-len(title))*" \u200b"
        return ""

class CustomHelpCommand(commands.HelpCommand):
    async def send_bot_help(self, mapping):
        help_embed = discord.Embed(
            title="Bot Parancsok",
            description="Az el√©rhet≈ë parancsok list√°ja.",
            color=0x00FF00
        )

        commands_info = {
            "play": {
                "description": "Zene lej√°tsz√°sa a csatorn√°ban.",
                "usage": "<prefix>play <c√≠m/link/playlist>",
                "aliases": ["p"],
                "enabled": config.musicplayer,
            },
            "league": {
                "description": "League of Legends statisztik√°k lek√©r√©se",
                "usage": "<prefix>league",
                "aliases": ["lol"],
                "enabled": config.lolapi,
            },
            "rivals": {
                "description": "Marvel Rivals statisztik√°k lek√©r√©se",
                "usage": "<prefix>rivals <n√©v> <szezon(0,1,1.5 ...)/update> <t√≠pus(√ºres,map,matchup)>",
                "aliases": ["rv"],
                "enabled": config.rivalsapi,
            },
            "clear": {
                "description": "Chat √ºzenetek t√∂rl√©se",
                "usage": "<prefix>clear <√ºzenetsz√°m>",
                "aliases": ["cl"],
                "enabled": config.clear,
            },
            "set_channel": {
                "description": "Csatorna be√°ll√≠t√°sa egy specifikus √ºzenethez.",
                "usage": "<prefix>set_channel <t√≠pus(music,rivals,lol,welcome)>",
                "aliases": ["sc"],
                "enabled": config.musicplayer or config.rivalsapi or config.lolapi or config.welcome,
            },
            "clear_channel": {
                "description": "Csatorna t√∂rl√©se egy specfikus √ºzenethez.",
                "usage": "<prefix>clear_channel <t√≠pus(music,rivals,lol,welcome)>",
                "aliases": ["cc"],
                "enabled": config.musicplayer or config.rivalsapi or config.lolapi or config.welcome,
            },
            "set_prefix": {
                "description": "Bot prefix be√°ll√≠t√°sa.",
                "usage": "<prefix>set_prefix <prefix>",
                "aliases": ["sp"],
                "enabled": config.prefixchange,
            },
            "set_welcome_msg": {
                "description": "√údv√∂zl≈ë √ºzenet be√°ll√≠t√°sa.",
                "usage": "<prefix>set_welcome_msg <√ºzenet>",
                "aliases": ["swm"],
                "enabled": config.welcome,
            },
            "set_welcome_rls": {
                "description": "Csatlakoz√°si rangok be√°ll√≠t√°sa.",
                "usage": "<prefix>set_welcome_rls <rangok>",
                "aliases": ["swr"],
                "enabled": config.welcome,
            },
            "system_message" : {
                "description": "Rendszer√ºzenet k√ºld√©se.",
                "usage": "<prefix>system_message <c√≠m> <√ºzenet>",
                "aliases": ["sm"],
                "enabled": config.systemmessage,
            },
            "add_restricted" : {
                "description": "Tiltott sz√≥ hozz√°ad√°sa.",
                "usage": "<prefix>add_restricted <szavak>",
                "aliases": ["ar"],
                "enabled": config.moderation
            },
            "remove_restricted" : {
                "description": "Tiltott sz√≥ t√∂rl√©se.",
                "usage": "<prefix>remove_restricted <szavak>",
                "aliases": ["rr"],
                "enabled": config.moderation
            },
            "clear_restricted" : {
                "description": "Tiltott szavak t√∂rl√©se.",
                "usage": "<prefix>clear_restricted",
                "aliases": ["cr"],
                "enabled": config.moderation
            }
        }

        command_info_list = []
        embed_field = ""
        for command, info in commands_info.items():
            if info["enabled"]:
                embed_field = f"**{command}**\n"
                embed_field += f"R√∂vid√≠t√©s: {', '.join(info['aliases'])}\n"
                embed_field += f"Le√≠r√°s: {info['description']}\n"
                embed_field += f"Haszn√°lat: {info['usage']}\n"

                command_info_list.append(embed_field)


        current_embed = None
        char_count = 0
        for command_info in command_info_list:
            if current_embed is None:
                current_embed = discord.Embed(
                    title="Bot Parancsok",
                    description="Az el√©rhet≈ë parancsok list√°ja.",
                    color=0x00FF00
                )
            if char_count + len(command_info) < 1024:
                current_embed.add_field(name="_____", value=command_info, inline=False)
                char_count += len(command_info)
            else:
                await self.context.send(embed=current_embed)
                current_embed = discord.Embed(
                    title="Bot Parancsok",
                    description="Az el√©rhet≈ë parancsok list√°ja.",
                    color=0x00FF00
                )
                current_embed.add_field(name="_____", value=command_info, inline=False)
                char_count = len(command_info)

        if current_embed:
            await self.context.send(embed=current_embed)